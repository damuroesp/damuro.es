// Datos de experiencias con rutas locales Y DESCRIPCIONES
const experiences = {
  'customer-service': {
    title: 'Atenci√≥n al cliente',
    icon: 'fas fa-headset',
    jobs: [
      {
        logo: 'src/img/logos/Orange.jpeg',
        company: 'Orange Espa√±a Servicios de Telemarketing',
        position: 'Teleoperador',
        duration: 'jun 2021 - jul 2021',
        description: 'Atenci√≥n al cliente para servicios de fibra y m√≥vil. Gesti√≥n de incidencias, venta de servicios y fidelizaci√≥n de clientes. Alto nivel de resoluci√≥n de problemas y satisfacci√≥n del cliente.'
      },
      {
        logo: 'src/img/logos/Liberbank.jpg',
        company: 'Liberbank',
        position: 'Teleoperador',
        duration: 'sep 2021 - sep 2021',
        description: 'Atenci√≥n a clientes bancarios, gesti√≥n de consultas sobre productos financieros, soporte en banca online y resoluci√≥n de incidencias. Cumplimiento de protocolos de seguridad y protecci√≥n de datos.'
      },
      {
        logo: 'src/img/logos/TotalEnergies.jpg',
        company: 'TotalEnergies',
        position: 'Teleoperador',
        duration: 'dic 2021 - mar 2022',
        description: 'Atenci√≥n a clients de energ√≠a, gesti√≥n de contrataciones, modificaciones contractuales y resoluci√≥n de incidencias. Formaci√≥n espec√≠fica en sector energ√©tico y comercializaci√≥n.'
      },
      {
        logo: 'src/img/logos/Liberbank.jpg',
        company: 'Liberbank',
        position: 'Teleoperador',
        duration: 'may 2022 - may 2022',
        description: 'Segunda etapa en Liberbank, especializado en gesti√≥n de cartera de clientes y fidelizaci√≥n. Implementaci√≥n de estrategias de retenci√≥n y mejora de la experiencia del cliente.'
      },
      {
        logo: 'src/img/logos/Ayesa.jpg',
        company: 'Ayesa',
        position: 'Teleoperador',
        duration: 'ene 2023 - mar 2023',
        description: 'Atenci√≥n multicanal (voz, email, chat) para clientes de diversos sectores. Enfoque en resoluci√≥n eficiente y medici√≥n de indicadores de calidad y satisfacci√≥n.'
      }
    ]
  },
  'media': {
    title: 'Medios de comunicaci√≥n',
    icon: 'fas fa-broadcast-tower',
    jobs: [
      {
        logo: 'src/img/logos/ElComercio.jpeg',
        company: 'Diario El Comercio',
        position: 'Colaborador',
        duration: 'oct 2009 - oct 2014',
        description: 'Colaboraciones en secci√≥n de tecnolog√≠a y videojuegos. Redacci√≥n de art√≠culos, an√°lisis de productos y cobertura de eventos. Desarrollo de habilidades de comunicaci√≥n y adaptaci√≥n de contenido para diferentes audiencias.'
      },
      {
        logo: 'src/img/logos/OPlay.jpeg',
        company: 'Ontech Play',
        position: 'Founder & Editor',
        duration: 'feb 2013 - jun 2019',
        description: 'Fundador y editor principal de medio especializado en tecnolog√≠a. Gesti√≥n de equipo de redactores, planificaci√≥n de contenidos, SEO, redes sociales y monetizaci√≥n. Crecimiento org√°nico hasta 10,000 visitas mensuales.'
      }
    ]
  },
  'sales': {
    title: 'Ventas',
    icon: 'fas fa-chart-line',
    jobs: [
      {
        logo: 'src/img/logos/LCDLC.png',
        company: 'La Casa de las Carcasas',
        position: 'Sales Assistant',
        duration: 'dic 2021 - ene 2022',
        description: 'Venta directa y asesoramiento personalizado en accesorios. Gestiono tu experiencia para que encuentres protecci√≥n, estilo o facilidad para tu m√≥vil. Juntos logramos tu objetivo y te vas con lo que necesitas.'
      },
      {
        logo: 'src/img/logos/NVIDIA.png',
        company: 'NVIDIA',
        position: 'Promotor',
        duration: 'ene 2024 - jun 2024',
        description: 'Impulsando la tecnolog√≠a NVIDIA en MediaMarkt Siero. Realizo demostraciones y ofrezco las mejores tarjetas gr√°ficas y soluciones de IA/Gaming. Juntos convertimos specs t√©cnicas en argumentos de venta.'
      },
      {
        logo: 'src/img/logos/Samsung.png',
        company: 'Samsung (Gama Blanca)',
        position: 'Promotor',
        duration: 'jul 2024 - jul 2024',
        description: 'Promociono la gama de electrodom√©sticos Samsung con las tecnolog√≠as m√°s innovadoras. Te muestro en persona c√≥mo ahorrar energ√≠a y cuidar del planeta con tu cocina. #MadeBySamsung'
      },
      {
        logo: 'src/img/logos/ASUS.png',
        company: 'ASUS',
        position: 'Promotor',
        duration: 'jul 2024 - jul 2025',
        description: 'Tu asesor especializado en tecnolog√≠a ASUS. Te ayudo a encontrar el port√°til, componente o perif√©rico que mejor se adapte a tus necesidades de gaming o trabajo. Experiencia de compra elevada y trato de usuario a usuario.'
      },
      {
        logo: 'src/img/logos/Samsung.png',
        company: 'Samsung (Galaxy)',
        position: 'Promotor',
        duration: 'jul 2025 - sep 2025',
        description: 'Promoci√≥n de dispositivos m√≥viles Samsung Galaxy. Demostraciones de funciones avanzadas, ecosistema de productos y ventajas competitivas. Alto conocimiento t√©cnico y habilidades de comunicaci√≥n.'
      }
    ]
  },
  'it': {
    title: 'Inform√°tica y Telecomunicaciones',
    icon: 'fas fa-laptop-code',
    jobs: [
      {
        logo: 'src/img/logos/Gijon.jpeg',
        company: 'Ayuntamiento de Gij√≥n (en pr√°cticas)',
        position: 'Helpdesk N1',
        duration: 'mar 2016 - jun 2016',
        description: 'Soporte t√©cnico a usuarios internos. Resoluci√≥n de incidencias de hardware y software, mantenimiento de equipos y gesti√≥n de tickets. Primer contacto profesional en entorno IT corporativo.'
      },
      {
        logo: 'src/img/logos/Magmacultura.jpeg',
        company: 'Magmacultura',
        position: 'T√©cnico de Realidad Virtual (VR)',
        duration: 'jun 2022 - jul 2022',
        description: 'Configuraci√≥n y mantenimiento de equipos de realidad virtual para eventos culturales. Soporte t√©cnico in situ, formaci√≥n de usuarios y resoluci√≥n de incidencias. Experiencia en tecnolog√≠as inmersivas.'
      },
      {
        logo: 'src/img/logos/Telecable.jpg',
        company: 'Telecable',
        position: 'Helpdesk N1',
        duration: 'jun 2023 - sep 2023',
        description: 'Atenci√≥n t√©cnica a clientes de telecomunicaciones. Diagn√≥stico remoto de incidencias, configuraci√≥n de routers y soporte para servicios de internet, telefon√≠a y televisi√≥n. Alto √≠ndice de resoluci√≥n en primer contacto.'
      }
    ]
  }
};

// ===== FUNCIONES PRINCIPALES (DEFINIDAS AL INICIO) =====

// Funci√≥n para generar archivo VCF
function generateVCF() {
  const vcfData = `BEGIN:VCARD
VERSION:3.0
FN:David Mu√±oz Rodr√≠guez
ORG:Tech Specialist
TITLE:Tech Specialist
TEL;TYPE=WORK,VOICE:+34 638 035 001
EMAIL;TYPE=PREF,INTERNET:david@dmunoz.es
URL:${window.location.href}
NOTE:#MakingThingsHappen
END:VCARD`;
  
  const blob = new Blob([vcfData], { type: 'text/vcard' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = 'david_munoz_rodriguez.vcf';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  
  URL.revokeObjectURL(url);
}

// Funci√≥n para descargar CV en espa√±ol
function downloadCVEsp() {
  const url = 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf';
  const a = document.createElement('a');
  a.href = url;
  a.download = 'David_Munoz_CV_Espanol.pdf';
  a.target = '_blank';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Funci√≥n para descargar CV en ingl√©s
function downloadCVEng() {
  const url = 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf';
  const a = document.createElement('a');
  a.href = url;
  a.download = 'David_Munoz_CV_English.pdf';
  a.target = '_blank';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Funciones de compartir
function shareViaWhatsApp() {
  const url = `https://api.whatsapp.com/send?text=Mira la tarjeta digital de David Mu√±oz - Tech Specialist: ${encodeURIComponent(window.location.href)}`;
  window.open(url, '_blank');
}

function shareViaTelegram() {
  const url = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=Mira la tarjeta digital de David Mu√±oz - Tech Specialist`;
  window.open(url, '_blank');
}

function shareViaEmail() {
  const subject = 'Tarjeta digital de David Mu√±oz - Tech Specialist';
  const body = `Te comparto la tarjeta digital de David Mu√±oz:\n\n${window.location.href}\n\nTech Specialist - #MakingThingsHappen`;
  window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

function shareViaLinkedIn() {
  const url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`;
  window.open(url, '_blank');
}

function shareViaTwitter() {
  const url = `https://twitter.com/intent/tweet?text=Mira la tarjeta digital de David Mu√±oz - Tech Specialist&url=${encodeURIComponent(window.location.href)}`;
  window.open(url, '_blank');
}

function copyToClipboard() {
  navigator.clipboard.writeText(window.location.href).then(function() {
    alert('Enlace copiado al portapapeles');
  }, function() {
    const textArea = document.createElement('textarea');
    textArea.value = window.location.href;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('Enlace copiado al portapapeles');
  });
}

// Funci√≥n para abrir el modal de experiencias
function openExperienceModal(category) {
  const experienceData = experiences[category];
  
  if (!experienceData) {
    console.error('Categor√≠a no encontrada:', category);
    return;
  }
  
  let content = '';
  
  experienceData.jobs.forEach(job => {
    content += `
      <div class="job">
        <div class="job-header">
          ${job.logo ? `<img src="${job.logo}" alt="${job.company}" class="job-logo" onerror="this.style.display='none'">` : ''}
          <div class="job-info">
            <h4>${job.position}</h4>
            <p>${job.company}</p>
            <span class="job-duration">${job.duration}</span>
          </div>
        </div>
        <div class="job-description">
          <p>${job.description}</p>
        </div>
      </div>
    `;
  });
  
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');
  const experienceModal = document.getElementById('experienceModal');
  
  modalTitle.innerHTML = `
    <div class="modal-category-icon">
      <i class="${experienceData.icon}"></i>
    </div>
    <span>${experienceData.title}</span>
  `;
  modalContent.innerHTML = content;
  experienceModal.style.display = 'block';
}

// ===== FUNCIONES PARA EL QR (DEFINIDAS AL INICIO) =====

function generateQRCode(qrCodeContainer) {
    console.log('üîÑ Generando c√≥digo QR...');
    if (!qrCodeContainer) {
        console.error('‚ùå qrCodeContainer no definido');
        return;
    }
    
    qrCodeContainer.innerHTML = '';
    
    if (typeof QRCode === 'undefined') {
        console.error('Librer√≠a QRCode no cargada');
        qrCodeContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #0066FF;">
                <i class="fas fa-qrcode" style="font-size: 80px; margin-bottom: 15px;"></i>
                <p style="font-weight: bold; margin: 10px 0;">David Mu√±oz Rodr√≠guez</p>
                <p>Tech Specialist</p>
                <p>#MakingThingsHappen</p>
            </div>
        `;
        return;
    }
    
    try {
        new QRCode(qrCodeContainer, {
            text: window.location.href,
            width: 200,
            height: 200,
            colorDark: "#0066FF",
            colorLight: "#FFFFFF",
            correctLevel: QRCode.CorrectLevel.H
        });
        console.log('‚úÖ QR generado correctamente para:', window.location.href);
    } catch (error) {
        console.error('‚ùå Error generando QR:', error);
    }
}

function saveQRCode(qrCodeContainer) {
    const canvas = qrCodeContainer.querySelector('canvas');
    if (canvas) {
        try {
            const image = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = image;
            a.download = 'david_munoz_qr.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            console.log('‚úÖ QR guardado correctamente');
        } catch (error) {
            console.error('‚ùå Error guardando QR:', error);
            alert('Error al guardar el QR. Int√©ntalo de nuevo.');
        }
    } else {
        console.error('‚ùå No se encontr√≥ el canvas del QR');
        alert('Primero genera el c√≥digo QR.');
    }
}

function shareQRCode(qrCodeContainer) {
    const canvas = qrCodeContainer.querySelector('canvas');
    if (canvas) {
        try {
            canvas.toBlob(function(blob) {
                if (navigator.share && navigator.canShare) {
                    const file = new File([blob], 'david_munoz_qr.png', { type: 'image/png' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: 'David Mu√±oz - Tech Specialist',
                            text: 'Escanea este QR para visitar mi perfil profesional - #MakingThingsHappen'
                        }).then(() => {
                            console.log('‚úÖ QR compartido exitosamente');
                        }).catch(error => {
                            console.log('‚ùå Compartir cancelado:', error);
                        });
                    } else {
                        saveQRCode(qrCodeContainer);
                    }
                } else {
                    saveQRCode(qrCodeContainer);
                }
            });
        } catch (error) {
            console.error('‚ùå Error compartiendo QR:', error);
            alert('Error al compartir el QR. Puedes guardarlo y compartirlo manualmente.');
        }
    } else {
        console.error('‚ùå No se encontr√≥ el canvas del QR');
        alert('Primero genera el c√≥digo QR.');
    }
}

function openQRModal(qrModal, qrCodeContainer) {
    console.log('üéØ Abriendo modal QR...');
    
    if (!qrModal) {
        console.error('‚ùå qrModal no definido');
        return;
    }
    
    generateQRCode(qrCodeContainer);
    
    qrModal.style.display = 'flex';
    setTimeout(() => {
        qrModal.classList.add('active');
    }, 10);
    
    console.log('‚úÖ Modal QR activado con QR de:', window.location.href);
}

function closeQRModal(qrModal) {
    if (!qrModal) return;
    
    qrModal.classList.remove('active');
    setTimeout(() => {
        qrModal.style.display = 'none';
    }, 300);
}

// Funci√≥n para cerrar el men√∫ flotante
function closeFloatingMenu(floatingButtons, mainFloatingBtn) {
    if (floatingButtons) floatingButtons.classList.remove('expanded');
    if (mainFloatingBtn) {
        const icon = mainFloatingBtn.querySelector('i');
        if (icon) icon.className = 'fas fa-plus';
    }
}

// ===== INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando aplicaci√≥n...');
    
    // ===== INICIALIZAR VARIABLES =====
    const qrModal = document.getElementById('qrModal');
    const qrCodeContainer = document.getElementById('qrCode');
    const qrClose = document.getElementById('qrClose');
    const saveQrBtn = document.getElementById('saveQrBtn');
    const shareQrBtn = document.getElementById('shareQrBtn');
    
    // Elementos de los botones flotantes
    const floatingButtons = document.getElementById('floatingButtons');
    const mainFloatingBtn = document.getElementById('mainFloatingBtn');
    const cvEspFloatingBtn = document.getElementById('cvEspFloatingBtn');
    const cvEngFloatingBtn = document.getElementById('cvEngFloatingBtn');
    const contactFloatingBtn = document.getElementById('contactFloatingBtn');
    const qrFloatingBtn = document.getElementById('qrFloatingBtn');
    const shareFloatingBtn = document.getElementById('shareFloatingBtn');
    
    // Modales
    const shareModal = document.getElementById('shareModal');
    const shareClose = document.getElementById('shareClose');
    const experienceModal = document.getElementById('experienceModal');
    const closeModal = document.querySelector('.close-modal');
    
    // Elementos de compartir
    const shareWhatsApp = document.getElementById('shareWhatsApp');
    const shareTelegram = document.getElementById('shareTelegram');
    const shareEmail = document.getElementById('shareEmail');
    const shareLinkedIn = document.getElementById('shareLinkedIn');
    const shareTwitter = document.getElementById('shareTwitter');
    const copyLink = document.getElementById('copyLink');
    
    // Otros elementos
    const accordionBtn = document.querySelector('.accordion-btn');
    const accordionContent = document.querySelector('.accordion-content');
    const categoryCards = document.querySelectorAll('.category-card');
    
    // Estado de los botones flotantes
    let isExpanded = false;
    
    // ===== EVENT LISTENERS PARA BOTONES FLOTANTES =====
    
    // Bot√≥n principal
    mainFloatingBtn.addEventListener('click', function() {
        isExpanded = !isExpanded;
        floatingButtons.classList.toggle('expanded', isExpanded);
        const icon = mainFloatingBtn.querySelector('i');
        icon.className = isExpanded ? 'fas fa-times' : 'fas fa-plus';
    });
    
    // CV Espa√±ol
    cvEspFloatingBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üìÑ CV Espa√±ol clickeado');
        downloadCVEsp();
        closeFloatingMenu(floatingButtons, mainFloatingBtn);
    });
    
    // CV Ingl√©s
    cvEngFloatingBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üìÑ CV Ingl√©s clickeado');
        downloadCVEng();
        closeFloatingMenu(floatingButtons, mainFloatingBtn);
    });
    
    // Contacto - VCF
    contactFloatingBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üìá Contacto clickeado');
        generateVCF();
        closeFloatingMenu(floatingButtons, mainFloatingBtn);
    });
    
    // QR - CORREGIDO: ahora pasa los par√°metros necesarios
    qrFloatingBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üéØ Bot√≥n QR clickeado');
        openQRModal(qrModal, qrCodeContainer);
        closeFloatingMenu(floatingButtons, mainFloatingBtn);
    });
    
    // Compartir
    shareFloatingBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üîó Compartir clickeado');
        if (shareModal) {
            shareModal.classList.add('active');
        }
        closeFloatingMenu(floatingButtons, mainFloatingBtn);
    });
    
    // ===== EVENT LISTENERS PARA MODALES =====
    
    // Cerrar modal QR
    qrClose.addEventListener('click', function(e) {
        e.preventDefault();
        closeQRModal(qrModal);
    });
    
    qrModal.addEventListener('click', function(e) {
        if (e.target === qrModal) closeQRModal(qrModal);
    });
    
    // Prevenir cierre accidental del modal QR
    const qrModalContent = qrModal.querySelector('.qr-modal-content');
    if (qrModalContent) {
        qrModalContent.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
    
    // Guardar QR
    saveQrBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üíæ Guardar QR clickeado');
        saveQRCode(qrCodeContainer);
    });
    
    // Compartir QR
    shareQrBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üîó Compartir QR clickeado');
        shareQRCode(qrCodeContainer);
    });
    
    // Modal compartir
    if (shareClose) {
        shareClose.addEventListener('click', function() {
            shareModal.classList.remove('active');
        });
    }
    
    if (shareModal) {
        shareModal.addEventListener('click', function(e) {
            if (e.target === shareModal) {
                shareModal.classList.remove('active');
            }
        });
    }
    
    // Botones de compartir
    if (shareWhatsApp) shareWhatsApp.addEventListener('click', shareViaWhatsApp);
    if (shareTelegram) shareTelegram.addEventListener('click', shareViaTelegram);
    if (shareEmail) shareEmail.addEventListener('click', shareViaEmail);
    if (shareLinkedIn) shareLinkedIn.addEventListener('click', shareViaLinkedIn);
    if (shareTwitter) shareTwitter.addEventListener('click', shareViaTwitter);
    if (copyLink) copyLink.addEventListener('click', copyToClipboard);
    
    // ===== EVENT LISTENERS PARA DASHBOARD =====
    categoryCards.forEach(card => {
        card.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            openExperienceModal(category);
        });
    });
    
    // Cerrar modal de experiencias
    closeModal.addEventListener('click', function() {
        experienceModal.style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
        if (event.target === experienceModal) {
            experienceModal.style.display = 'none';
        }
    });
    
    // ===== EVENT LISTENERS PARA OTROS ELEMENTOS =====
    
    // Acorde√≥n
    accordionBtn.addEventListener('click', function() {
        this.classList.toggle('active');
        accordionContent.classList.toggle('active');
    });
    
    // Botones de contacto en la secci√≥n principal
    document.querySelectorAll('.btn-call').forEach(btn => {
        btn.addEventListener('click', function() {
            window.open('tel:+34638035001');
        });
    });
    
    document.querySelectorAll('.btn-whatsapp').forEach(btn => {
        btn.addEventListener('click', function() {
            window.open('https://wa.me/34638035001');
        });
    });
    
    document.querySelectorAll('.btn-email').forEach(btn => {
        btn.addEventListener('click', function() {
            window.location.href = 'mailto:david@dmunoz.es';
        });
    });
    
    // Sticky banner
    window.addEventListener('scroll', function() {
        const stickyBanner = document.getElementById('stickyBanner');
        if (window.scrollY > 100) {
            stickyBanner.classList.add('compact');
        } else {
            stickyBanner.classList.remove('compact');
        }
    });
    
    console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
});